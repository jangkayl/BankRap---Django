{% extends 'base.html' %}
{% load static %}

{% block title %}Write Review - BankRap{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto py-12">

    <!-- Main Card -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">

        <!-- Header / Profile Section -->
        <div class="bg-gray-50/50 p-8 border-b border-gray-100 flex flex-col items-center text-center">
            <h1 class="text-xl font-bold text-gray-900 mb-6">Rate your experience</h1>

            <!-- Profile Avatar (Initial) -->
            <div class="relative mb-3">
                <div class="w-20 h-20 rounded-full bg-white border border-gray-200 flex items-center justify-center text-3xl font-bold text-gray-700 shadow-sm">
                    {{ reviewee.name|slice:":1" }}
                </div>
                <div class="absolute bottom-0 right-0 bg-white rounded-full p-1 shadow-sm border border-gray-100">
                    {% if reviewee.type == 'L' %}
                        <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center">
                            <i data-lucide="briefcase" class="w-3 h-3 text-green-700"></i>
                        </div>
                    {% else %}
                        <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                            <i data-lucide="user" class="w-3 h-3 text-blue-700"></i>
                        </div>
                    {% endif %}
                </div>
            </div>

            <h2 class="text-2xl font-extrabold text-gray-900 mb-1">{{ reviewee.name }}</h2>

            <div class="flex items-center space-x-2 text-sm">
                <span class="px-2.5 py-0.5 rounded-md font-bold text-[10px] uppercase tracking-wider
                    {% if reviewee.type == 'L' %}bg-green-100 text-green-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                    {% if reviewee.type == 'L' %}Lender{% else %}Borrower{% endif %}
                </span>
                <span class="text-gray-400">â€¢</span>
                <span class="text-gray-500 font-medium">Loan #{{ loan.loan_id }}</span>
            </div>
        </div>

        <!-- Review Form -->
        <div class="p-8">
            <form method="POST">
                {% csrf_token %}

                <!-- Star Rating -->
                <div class="mb-8 text-center">
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-3">How was your transaction?</label>
                    <div class="flex justify-center items-center space-x-2" id="star-container">
                        {% for i in "12345" %}
                        <label class="cursor-pointer group relative">
                            <input type="radio" name="rating" value="{{ i }}" class="peer sr-only" required>
                            <i data-lucide="star" class="w-10 h-10 text-gray-200 peer-checked:text-yellow-400 peer-checked:fill-yellow-400 hover:text-yellow-400 hover:fill-yellow-400 transition-all duration-200 transform hover:scale-110"></i>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Comment Area -->
                <div class="mb-8">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Write a review</label>
                    <textarea name="comment" rows="4"
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:outline-none focus:ring-2 focus:ring-brand-red focus:border-transparent transition-all text-gray-900 placeholder-gray-400 resize-none"
                        placeholder="Share details about your experience working with {{ reviewee.name }}..." required></textarea>
                </div>

                <!-- Actions -->
                <div class="flex flex-col-reverse sm:flex-row sm:justify-between gap-3">
                    <a href="{% url 'dashboard' %}" class="w-full sm:w-auto px-6 py-3 text-center text-sm font-bold text-gray-500 hover:text-gray-700 hover:bg-gray-50 rounded-xl transition-colors">
                        Cancel
                    </a>
                    <button type="submit" class="w-full sm:w-auto flex-1 px-8 py-3 bg-brand-red hover:bg-red-900 text-white font-bold rounded-xl transition-all shadow-md transform hover:-translate-y-0.5 flex justify-center items-center">
                        Submit Review
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    /* Custom star rating logic to handle hover/fill preview via CSS only is tricky without JS or complex CSS.
       This simple JS helps fill stars up to the hovered/selected one for better UX */
</style>

<script>
    // Optional: Add simple interactivity to stars if needed beyond CSS peer-checked
    const stars = document.querySelectorAll('#star-container label');

    stars.forEach((star, index) => {
        star.addEventListener('mouseenter', () => {
            // Highlight all stars up to this one
            for(let i=0; i<=index; i++) {
                stars[i].querySelector('svg').classList.add('text-yellow-400', 'fill-yellow-400');
                stars[i].querySelector('svg').classList.remove('text-gray-200');
            }
        });

        star.addEventListener('mouseleave', () => {
            // Remove highlight (CSS peer-checked will handle selection state)
             stars.forEach(s => {
                // Only reset if not checked
                const input = s.querySelector('input');
                if(!input.checked) {
                    s.querySelector('svg').classList.remove('text-yellow-400', 'fill-yellow-400');
                    s.querySelector('svg').classList.add('text-gray-200');
                }
             });
             // Re-apply checked state
             const checked = document.querySelector('input[name="rating"]:checked');
             if(checked) {
                 const checkedIndex = parseInt(checked.value) - 1;
                 for(let i=0; i<=checkedIndex; i++) {
                    stars[i].querySelector('svg').classList.add('text-yellow-400', 'fill-yellow-400');
                    stars[i].querySelector('svg').classList.remove('text-gray-200');
                 }
             }
        });

        star.addEventListener('click', () => {
             // Force visual update
             setTimeout(() => {
                 const checkedIndex = parseInt(star.querySelector('input').value) - 1;
                 stars.forEach((s, i) => {
                     if(i <= checkedIndex) {
                        s.querySelector('svg').classList.add('text-yellow-400', 'fill-yellow-400');
                        s.querySelector('svg').classList.remove('text-gray-200');
                     } else {
                        s.querySelector('svg').classList.remove('text-yellow-400', 'fill-yellow-400');
                        s.querySelector('svg').classList.add('text-gray-200');
                     }
                 });
             }, 10);
        });
    });
</script>
{% endblock %}