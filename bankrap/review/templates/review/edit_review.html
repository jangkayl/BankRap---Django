{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Review - BankRap{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto py-12">

    <!-- Main Card -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">

        <!-- Header / Profile Section -->
        <div class="bg-gray-50/50 p-8 border-b border-gray-100 flex flex-col items-center text-center">
            <h1 class="text-xl font-bold text-gray-900 mb-6">Edit Your Review</h1>

            <!-- Profile Avatar -->
            <div class="relative mb-3">
                <div class="w-20 h-20 rounded-full bg-white border border-gray-200 flex items-center justify-center text-3xl font-bold text-gray-700 shadow-sm">
                    {{ reviewee.name|slice:":1" }}
                </div>
                <div class="absolute bottom-0 right-0 bg-white rounded-full p-1 shadow-sm border border-gray-100">
                    {% if reviewee.type == 'L' %}
                        <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center">
                            <i data-lucide="briefcase" class="w-3 h-3 text-green-700"></i>
                        </div>
                    {% else %}
                        <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                            <i data-lucide="user" class="w-3 h-3 text-blue-700"></i>
                        </div>
                    {% endif %}
                </div>
            </div>

            <h2 class="text-2xl font-extrabold text-gray-900 mb-1">{{ reviewee.name }}</h2>

            <div class="flex items-center space-x-2 text-sm">
                <span class="px-2.5 py-0.5 rounded-md font-bold text-[10px] uppercase tracking-wider
                    {% if reviewee.type == 'L' %}bg-green-100 text-green-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                    {% if reviewee.type == 'L' %}Lender{% else %}Borrower{% endif %}
                </span>
                <span class="text-gray-400">â€¢</span>
                <span class="text-gray-500 font-medium">Loan #{{ loan.loan_id }}</span>
            </div>
        </div>

        <!-- Review Form -->
        <div class="p-8">
            <form method="POST" id="editReviewForm">
                {% csrf_token %}

                <!-- Star Rating -->
                <div class="mb-8 text-center">
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-3">How was your transaction?</label>
                    <div class="flex justify-center items-center space-x-2" id="star-container">
                        {% for i in "12345" %}
                        <label class="cursor-pointer group relative">
                            <input type="radio" name="rating" value="{{ i }}"
                                   class="peer sr-only"
                                   required
                                   {% if review.rating == forloop.counter %}checked{% endif %}>
                            <i data-lucide="star" class="w-10 h-10 text-gray-200 peer-checked:text-yellow-400 peer-checked:fill-yellow-400 hover:text-yellow-400 hover:fill-yellow-400 transition-all duration-200 transform hover:scale-110"></i>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Comment Area -->
                <div class="mb-8">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Edit your review</label>
                    <textarea name="comment" rows="4"
                        class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:outline-none focus:ring-2 focus:ring-brand-red focus:border-transparent transition-all text-gray-900 placeholder-gray-400 resize-none"
                        placeholder="Share details about your experience working with {{ reviewee.name }}..."
                        required>{{ review.comment }}</textarea>
                </div>

                <!-- Actions -->
                <div class="flex flex-col-reverse sm:flex-row sm:justify-between gap-3">
                    <a href="{% url 'reviews' %}?tab=given" class="w-full sm:w-auto px-6 py-3 text-center text-sm font-bold text-gray-500 hover:text-gray-700 hover:bg-gray-50 rounded-xl transition-colors">
                        Cancel
                    </a>
                    <div class="flex gap-3">
                        <button type="button"
                                onclick="confirmDelete()"
                                class="w-full sm:w-auto px-6 py-3 text-center text-sm font-bold text-red-600 hover:text-red-800 hover:bg-red-50 rounded-xl transition-colors border border-red-200">
                            Delete
                        </button>
                        <button type="submit" class="w-full sm:w-auto flex-1 px-8 py-3 bg-brand-red hover:bg-red-900 text-white font-bold rounded-xl transition-all shadow-md transform hover:-translate-y-0.5 flex justify-center items-center">
                            Update Review
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Star rating interactivity (same as create review)
    const stars = document.querySelectorAll('#star-container label');

    function updateStars() {
        const checked = document.querySelector('input[name="rating"]:checked');
        if (checked) {
            const checkedIndex = parseInt(checked.value) - 1;
            stars.forEach((s, i) => {
                if(i <= checkedIndex) {
                    s.querySelector('svg').classList.add('text-yellow-400', 'fill-yellow-400');
                    s.querySelector('svg').classList.remove('text-gray-200');
                } else {
                    s.querySelector('svg').classList.remove('text-yellow-400', 'fill-yellow-400');
                    s.querySelector('svg').classList.add('text-gray-200');
                }
            });
        }
    }

    stars.forEach((star, index) => {
        star.addEventListener('mouseenter', () => {
            for(let i=0; i<=index; i++) {
                stars[i].querySelector('svg').classList.add('text-yellow-400', 'fill-yellow-400');
                stars[i].querySelector('svg').classList.remove('text-gray-200');
            }
        });

        star.addEventListener('mouseleave', updateStars);
        star.addEventListener('click', () => {
            setTimeout(updateStars, 10);
        });
    });

    // Initialize stars on load
    document.addEventListener('DOMContentLoaded', updateStars);

    // Delete confirmation
    function confirmDelete() {
        if (confirm('Are you sure you want to delete this review? This action cannot be undone.')) {
            fetch('{% url "delete_review" review.review_id %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '{% url "reviews" %}?tab=given';
                } else {
                    alert('Failed to delete review: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the review.');
            });
        }
    }
</script>
{% endblock %}