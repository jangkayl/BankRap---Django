{% extends 'base.html' %}
{% load static %}

{% block title %}Repayment Schedule - BankRap{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">

    <div class="mb-8">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">
            {% if user.type == 'B' %}My Repayments{% else %}Portfolio Repayments{% endif %}
        </h1>
        <p class="text-gray-500">
            {% if user.type == 'B' %}Track your dues and payment history.{% else %}Track incoming payments from your investments.{% endif %}
        </p>
    </div>

    <!-- Enhanced Stats Row -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">

        <!-- Total Due/Receivable Card -->
        <div class="relative overflow-hidden rounded-2xl p-6 text-white shadow-lg
            {% if user.type == 'B' %}
                bg-gradient-to-br from-red-600 to-red-700 shadow-red-200
            {% else %}
                bg-gradient-to-br from-emerald-600 to-emerald-700 shadow-emerald-200
            {% endif %}">

            <div class="relative z-10">
                <p class="text-white/80 text-xs font-bold uppercase tracking-wider mb-1">
                    {% if user.type == 'B' %}Total Payable{% else %}Total Receivable{% endif %}
                </p>
                <h3 class="text-3xl font-extrabold">₱{{ total_due|floatformat:2 }}</h3>
                <p class="text-white/70 text-xs mt-2">{{ active_count }} Active Loan(s)</p>
            </div>
            <div class="absolute right-0 top-0 p-4 opacity-10">
                {% if user.type == 'B' %}
                    <i data-lucide="trending-down" class="w-24 h-24 text-white"></i>
                {% else %}
                    <i data-lucide="trending-up" class="w-24 h-24 text-white"></i>
                {% endif %}
            </div>
        </div>

        <!-- Next Payment Card -->
        <div class="relative overflow-hidden bg-white rounded-2xl p-6 border border-gray-100 shadow-sm group">
            <p class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-1">
                {% if user.type == 'B' %}Next Due{% else %}Next Incoming{% endif %}
            </p>
            {% if next_amount > 0 %}
                <h3 class="text-3xl font-extrabold text-gray-900">₱{{ next_amount|floatformat:2 }}</h3>
                <p class="text-sm font-bold mt-2 flex items-center {% if user.type == 'B' %}text-red-600{% else %}text-emerald-600{% endif %}">
                    <i data-lucide="calendar" class="w-4 h-4 mr-1"></i> {{ next_date|date:"M d, Y" }}
                </p>
            {% else %}
                <h3 class="text-2xl font-bold text-gray-400">Nothing Due</h3>
                <p class="text-gray-500 text-sm font-medium mt-2">No pending payments.</p>
            {% endif %}
            <div class="absolute right-4 top-4 bg-gray-50 p-2 rounded-full">
                <i data-lucide="clock" class="w-6 h-6 text-gray-400"></i>
            </div>
        </div>

        <!-- Total Paid/Collected Card -->
        <div class="relative overflow-hidden bg-white rounded-2xl p-6 border border-gray-100 shadow-sm">
            <p class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-1">
                {% if user.type == 'B' %}Total Repaid{% else %}Total Collected{% endif %}
            </p>
            <h3 class="text-3xl font-extrabold text-blue-600">₱{{ total_paid|floatformat:2 }}</h3>
            <p class="text-gray-400 text-xs mt-2">Lifetime completed.</p>
            <div class="absolute right-4 top-4 bg-blue-50 p-2 rounded-full">
                <i data-lucide="check-circle" class="w-6 h-6 text-blue-600"></i>
            </div>
        </div>
    </div>

    <h2 class="text-lg font-bold text-gray-900 mb-4">Loan List</h2>

    <div class="space-y-4">
        {% for loan in active_loans %}
        <!-- Entire card is clickable except buttons -->
        <div class="group relative bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md hover:border-brand-red/30 transition-all cursor-pointer"
             onclick="if(!event.target.closest('button')) window.location.href='{% url 'loan_detail' loan.loan_request.loan_id %}'">

            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">

                <div class="flex-1 grid grid-cols-2 sm:grid-cols-4 gap-6 items-center">
                    <div>
                        <p class="text-xs text-gray-400 font-bold uppercase mb-1">Due Date</p>
                        <p class="font-bold text-gray-900 group-hover:text-brand-red transition-colors">{{ loan.due_date|date:"M d, Y" }}</p>
                    </div>

                    <div>
                        <p class="text-xs text-gray-400 font-bold uppercase mb-1">
                            {% if user.type == 'B' %}Repayment Amount{% else %}Incoming Amount{% endif %}
                        </p>
                        <p class="font-bold text-gray-900 text-lg">₱{{ loan.total_repayment|floatformat:2 }}</p>
                    </div>

                    <div>
                        <p class="text-xs text-gray-400 font-bold uppercase mb-1">
                            {% if user.type == 'B' %}Lender{% else %}Borrower{% endif %}
                        </p>
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-600 mr-2 border border-gray-200">
                                {% if user.type == 'B' %}{{ loan.lender.name|slice:":1" }}{% else %}{{ loan.borrower.name|slice:":1" }}{% endif %}
                            </div>
                            <p class="font-medium text-gray-700 text-sm">
                                {% if user.type == 'B' %}{{ loan.lender.name }}{% else %}{{ loan.borrower.name }}{% endif %}
                            </p>
                        </div>
                    </div>

                    <div>
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold uppercase tracking-wide
                            {% if loan.status == 'ACTIVE' %}bg-blue-50 text-blue-700 border border-blue-100
                            {% elif loan.status == 'PAID' %}bg-green-50 text-green-700 border border-green-100
                            {% else %}bg-red-50 text-red-700 border border-red-100{% endif %}">
                            {{ loan.status }}
                        </span>
                    </div>
                </div>

                <!-- Actions -->
                <div class="relative z-10">
                    {% if user.type == 'B' and loan.status == 'ACTIVE' %}
                    <button onclick="openPayModal('{{ loan.active_loan_id }}', '{{ loan.total_repayment }}', '{{ loan.lender.name }}'); event.stopPropagation();"
                        class="w-full sm:w-auto px-6 py-2.5 bg-brand-red hover:bg-red-900 text-white font-bold rounded-xl text-sm transition-colors shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                        Pay Now
                    </button>
                    {% elif user.type == 'L' and loan.status == 'ACTIVE' %}
                    <span class="w-full sm:w-auto px-6 py-2.5 bg-gray-50 text-gray-400 font-bold rounded-xl text-sm border border-gray-200 cursor-default flex items-center justify-center">
                        <i data-lucide="clock" class="w-4 h-4 mr-2"></i> Awaiting
                    </span>
                    {% elif loan.status == 'PAID' %}
                        <!-- If paid, allow lender to review borrower -->
                         <a href="{% url 'create_review' loan.loan_request.loan_id %}" onclick="event.stopPropagation();" class="w-full sm:w-auto px-6 py-2.5 bg-yellow-400 hover:bg-yellow-500 text-white font-bold rounded-xl text-sm transition-colors shadow-sm flex items-center justify-center">
                            <i data-lucide="star" class="w-4 h-4 mr-2"></i> Rate
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="bg-white border border-dashed border-gray-200 rounded-2xl p-16 text-center">
            <div class="mx-auto w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4">
                <i data-lucide="inbox" class="w-8 h-8 text-gray-300"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-1">No Active Loans</h3>
            <p class="text-gray-500">
                {% if user.type == 'B' %}You don't have any loans to repay.{% else %}You don't have any active investments.{% endif %}
            </p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Pay Confirmation Modal (Same as before) -->
<div id="pay-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative transform transition-all scale-100">
        <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                <i data-lucide="credit-card" class="h-6 w-6 text-blue-600"></i>
            </div>
            <h3 class="text-lg leading-6 font-bold text-gray-900" id="modal-title">Confirm Repayment</h3>
            <div class="mt-2">
                <p class="text-sm text-gray-500">
                    You are paying <span class="font-bold text-gray-900" id="pay-amount">₱0.00</span> to <span class="font-bold text-gray-900" id="pay-lender">Lender</span>.
                </p>
                <p class="text-xs text-gray-400 mt-2">
                    This amount will be deducted from your wallet immediately. Ensure you have sufficient funds.
                </p>
            </div>
        </div>
        <div class="mt-6 flex justify-center space-x-3">
            <button onclick="closeModal('pay-modal')" class="px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-lg text-sm font-bold hover:bg-gray-50 transition-colors">
                Cancel
            </button>
            <form id="pay-form" method="POST" action="">
                {% csrf_token %}
                <button type="submit" class="px-4 py-2 bg-brand-red text-white rounded-lg text-sm font-bold hover:bg-red-900 transition-colors shadow-sm">
                    Confirm Payment
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    function openPayModal(loanId, amount, lenderName) {
        document.getElementById('pay-lender').textContent = lenderName;
        document.getElementById('pay-amount').textContent = '₱' + parseFloat(amount).toLocaleString('en-US', {minimumFractionDigits: 2});

        const form = document.getElementById('pay-form');
        form.action = "/repayments/" + loanId + "/pay/";

        document.getElementById('pay-modal').classList.remove('hidden');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    }

    window.onclick = function(event) {
        if (event.target.classList.contains('fixed')) {
            event.target.classList.add('hidden');
        }
    }
</script>
{% endblock %}