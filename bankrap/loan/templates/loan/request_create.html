{% extends 'base.html' %}
{% load static %}

{% block title %}Create Request - BankRap{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-8">
    
    <div class="mb-8">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Submit a New Loan Request</h1>
        <p class="text-gray-500">Fill out the form below to initiate your loan request.</p>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">

        <form method="POST" action="{% url 'loan_create' %}">
            {% csrf_token %}

            <h2 class="text-lg font-bold text-gray-900 mb-1">Loan Details</h2>
            <p class="text-sm text-gray-500 mb-6">Specify the amount and terms.</p>

            <!-- Amount & Interest Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Loan Amount (PHP)</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3 text-gray-500 font-medium">₱</span>
                        <!-- Added ID for JS -->
                        <input type="number" id="loan_amount" name="amount" required step="0.01" min="100"
                            class="w-full pl-8 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-red transition-all"
                            placeholder="e.g., 5000.00">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Interest Rate (%)</label>
                    <div class="relative mb-2">
                        <!-- Added ID for JS -->
                        <input type="number" id="interest_input" name="interest_rate" value="5" min="1" max="50" step="0.1"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-red transition-all text-right pr-8">
                        <span class="absolute right-4 top-3 text-gray-500 font-medium">%</span>
                    </div>
                    <input type="range" id="interest_slider" min="1" max="50" value="5" step="0.5"
                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-brand-red">
                </div>
            </div>

            <!-- Live Calculation Box -->
            <div class="bg-red-50 border border-red-100 rounded-xl p-4 mb-8 flex flex-col sm:flex-row justify-between items-center text-center sm:text-left">
                <div>
                    <p class="text-xs font-bold text-brand-red uppercase tracking-wide">Estimated Repayment</p>
                    <p class="text-xs text-gray-500">Total amount you will pay back</p>
                </div>
                <div class="mt-2 sm:mt-0">
                    <span class="text-2xl font-extrabold text-brand-red" id="total_repayment_display">₱0.00</span>
                </div>
            </div>

            <div class="mb-8">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Purpose of Loan</label>
                <textarea name="purpose" rows="3" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-red transition-all placeholder-gray-400"
                    placeholder="e.g. Tuition fee balance, Thesis project materials"></textarea>
            </div>

            <div class="mb-8">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Term Duration</label>
                <div class="relative">
                    <select name="term" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-brand-red cursor-pointer bg-white">
                        <option value="" disabled selected>Select a duration</option>
                        <option value="7_DAYS">7 Days</option>
                        <option value="15_DAYS">15 Days</option>
                        <option value="1_MONTH">1 Month</option>
                        <option value="2_MONTHS">2 Months</option>
                        <option value="3_MONTHS">3 Months</option>
                        <option value="4_MONTHS">4 Months</option>
                        <option value="5_MONTHS">5 Months</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-700">
                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                    </div>
                </div>
                <p class="mt-2 text-xs text-gray-400">Short-term loans (7 days - 5 months) only.</p>
            </div>

            <div class="flex items-center justify-end space-x-6 pt-4 border-t border-gray-50">
                <a href="{% url 'my_loan_requests' %}" class="text-sm font-bold text-gray-600 hover:text-gray-900">Cancel</a>
                <button type="submit" class="px-8 py-3 bg-brand-red hover:bg-red-900 text-white font-bold rounded-lg transition-colors shadow-md transform hover:-translate-y-0.5">
                    Submit Request
                </button>
            </div>

        </form>
    </div>
</div>

<script>
    // Elements
    const slider = document.getElementById('interest_slider');
    const inputInterest = document.getElementById('interest_input');
    const inputAmount = document.getElementById('loan_amount');
    const totalDisplay = document.getElementById('total_repayment_display');

    // Sync Slider and Input
    slider.addEventListener('input', function() {
        inputInterest.value = this.value;
        calculateTotal();
    });

    inputInterest.addEventListener('input', function() {
        slider.value = this.value;
        calculateTotal();
    });

    inputAmount.addEventListener('input', calculateTotal);

    function calculateTotal() {
        const principal = parseFloat(inputAmount.value) || 0;
        const rate = parseFloat(inputInterest.value) || 0;

        // Simple Interest Calculation: Total = Principal + (Principal * (Rate / 100))
        const interestAmount = principal * (rate / 100);
        const total = principal + interestAmount;

        // Format to Currency
        totalDisplay.innerText = '₱' + total.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
</script>
{% endblock %}